<header class="bg-cyan-700 text-white p-4 rounded-t-lg flex justify-between items-center shadow-sm">
  <h1 class="text-xl font-semibold">Mis Pedidos</h1>
  <span class="text-sm opacity-90">
    Actualizado al {{ today | date:'dd/MM/yyyy' }}
  </span>
</header>

<div class="p-4 bg-gray-50">

  <!-- FILTROS -->
  <div class="bg-white shadow-md rounded-xl p-4 border border-gray-200 flex flex-col sm:flex-row sm:items-center gap-4">

    <div class="text-gray-600 text-center sm:text-left sm:mr-auto">
      <div class="font-semibold flex items-center justify-center sm:justify-start gap-2"
           [ngClass]="{ 'mb-3 mt-3': authService.isAdmin()}">

        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-600"
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 12a4 4 0 100-8 4 4 0 000 8z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5.121 17.804A9 9 0 1118.879 17.804"/>
        </svg>

        <ng-container *ngIf="userCustCodes.length > 1; else singleCustomer">
          <select [(ngModel)]="selectedCustCode"
                  (change)="onCustomerChange()"
                  class="select select-bordered bg-gray-50">
            <option *ngFor="let code of sortedUserCustCodes" [value]="code">
              {{ customersData[code].name || code }}
            </option>
          </select>
        </ng-container>

        <ng-template #singleCustomer>
          <span>{{ customerName }}</span>
        </ng-template>
      </div>
    </div>

    <select class="select select-bordered bg-gray-50 w-full sm:w-64"
            [(ngModel)]="selectedProject"
            (change)="onSelectProject()">
      <option value="">Todas las obras</option>
      <option *ngFor="let proj of projectOptions"
              [value]="proj.proj_code.trim()">
        {{ proj.proj_code.trim() }} - {{ proj.proj_name.trim() }}
      </option>
    </select>

    <button
      class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg"
      (click)="clearFilter()">
           <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 20l5-5m0 0l3 3m-3-3l6-6m3-3a2.828 2.828 0 10-4-4l4 4z"
          />
        </svg>
      Limpiar
    </button>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="flex flex-col items-center p-10 text-gray-500">
    <img src="assets/images/logoHORMIGONES.png" class="h-8 w-8 animate-pulse" />
    <span>Cargando pedidos...</span>
  </div>

  <!-- SIN OBRA -->
  <div *ngIf="!loading && !hasSelectedProject"
       class="bg-white rounded-2xl mt-10 p-10 text-center text-gray-500 shadow animate__animated animate__fadeIn">
       <div class="flex justify-center mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-14 h-14 text-cyan-600"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="1.5">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 9v3.75m0 3h.008M10.29 3.86l-8.09 14.02A1.5 1.5 0 0 0 3.5 20.25h17a1.5 1.5 0 0 0 1.3-2.37L13.71 3.86a1.5 1.5 0 0 0-2.42 0Z" />
      </svg>
    </div>
    <p class="text-lg font-semibold">Debes seleccionar una obra</p>
    <p class="text-sm">Selecciona un proyecto para ver los pedidos</p>
  </div>

  <!-- BOTONES ACTUALES / FUTUROS -->
  <div *ngIf="!loading && hasSelectedProject"
       class="flex justify-center gap-4 mt-8 animate__animated animate__fadeIn">
    <button
      class="px-6 py-2 rounded-lg font-medium"
      [class.bg-cyan-700]="viewMode === 'ACTUALES'"
      [class.text-white]="viewMode === 'ACTUALES'"
      [class.bg-gray-200]="viewMode !== 'ACTUALES'"
      (click)="selectViewMode('ACTUALES')">
      Pedidos actuales
    </button>

    <button
      class="px-6 py-2 rounded-lg font-medium"
      [class.bg-cyan-700]="viewMode === 'FUTUROS'"
      [class.text-white]="viewMode === 'FUTUROS'"
      [class.bg-gray-200]="viewMode !== 'FUTUROS'"
      (click)="selectViewMode('FUTUROS')">
      Pedidos futuros
    </button>
  </div>

  <!-- ===================== -->
  <!-- CARDS - ACTUALES -->
  <!-- ===================== -->
  <div *ngIf="viewMode === 'ACTUALES' && filteredOrders.length"
       class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-10 animate__animated animate__fadeIn">

       <!-- (click)="onOpenOrder(ord, $event)" -->
    <div *ngFor="let ord of filteredOrders"
         class="bg-white rounded-2xl shadow-lg border p-5
                hover:shadow-xl transition cursor-pointer">

      <div class="text-center mb-3">
        <p class="text-sm text-black uppercase">
          {{ ord.proj_name }}        
        </p>
        <p class="text-xs text-gray-500">
          Proyecto <b>{{ ord.proj_code.trim() }}</b>
        </p>
        <p class="text-xs text-gray-500">
          <!-- address -->
          <b></b> 
        </p>
      </div>

      <div class="text-center mb-3">
        <p class="text-xs text-gray-500">
          <b>{{ ord.ship_addr_line }}</b>
        </p>        
      </div>

      <div class="text-center mb-3">
        <p class="font-semibold text-gray-700">
          {{ ord.prod_code.trim() }} / {{ ord.prod_descr.trim() }}
        </p>
      </div>
     <div class="grid grid-cols-3 gap-x-4 gap-y-1 mb-3 text-xs text-black text-center">
        <span class="font-semibold">Cod. Pedido</span>
        <span class="font-semibold">Inicio</span>
        <span class="font-semibold">Frecuencia</span>
        <span>{{ ord.order_code }}</span>
        <span>{{ ord.start_time | hora }}</span>
        <span>{{ ord.truck_spacing_mins }} min</span>
      </div>
      <!-- <div class="text-xs text-red-500 text-center">
        DEBUG: {{ ord.delv_qty }} / {{ ord.order_qty }}
      </div> -->


      <div class="flex justify-center my-4">        
      <app-progress-circle
  [value]="ord.ejecutado"
  [total]="ord.order_qty">
</app-progress-circle>

<!-- MENSAJE CLARO -->
<p
  *ngIf="!ord.descargaConfirmada"
  class="text-xs text-gray-500 mt-1 text-center"
>
  Descarga pendiente de confirmación<br>
  <span class="italic">
    El avance se actualiza cuando las guías pasan a estado
    <b>En Obra</b>
  </span>
</p>

      </div>

      <div class="flex justify-center">
        <span class="px-3 py-1 text-xs rounded-full
                     bg-green-100 text-green-700">
          {{ ord.estado }}
        </span>
      </div>

      <button
        *ngIf="viewMode === 'ACTUALES'"
        class="mt-4 w-full bg-red-500 hover:bg-red-600
               text-white py-2 rounded-lg"
               (click)="goToSeguimiento(ord, $event)">
        Ver detalle
      </button>
    </div>
  </div>

  <!-- ===================== -->
  <!-- TABLA - FUTUROS -->
  <!-- ===================== -->
  <div
    *ngIf="viewMode === 'FUTUROS' && filteredOrders.length"
    class="mt-10 bg-white shadow-lg rounded-2xl border border-gray-200 overflow-x-auto animate__animated animate__fadeIn"
  >

    <table class="min-w-full text-sm">
      <thead class="bg-cyan-700 text-white">
        <tr>
          <th class="p-3 text-left">Fecha</th>
          <th class="p-3 max-w-[160px] sm:max-w-none
                  overflow-x-auto
                  whitespace-nowrap
                  scrollbar-thin">Hora inicio</th>
          <th class="p-3 text-left">Proyecto</th>
          <th class="p-3 max-w-[160px] sm:max-w-none
                  overflow-x-auto
                  whitespace-nowrap
                  scrollbar-thin">Cod. Producto</th>
          <th class="p-3 text-left">Producto</th>
          <th class="p-3 text-left">m³</th>
          <th class="p-3 text-left">Camiones</th>
          <th class="p-3 text-left">Frecuencia</th>
          <th class="p-3 text-left">Dirección</th>
          <th class="p-3 text-left">Comuna</th>
          <th class="p-3 text-left">Estado</th>
        </tr>
      </thead>

      <tbody>
        <tr
          *ngFor="let ord of filteredOrders"
          class="border-t bg-white hover:bg-cyan-50 cursor-pointer"
          (click)="onOpenOrder(ord, $event)"
        >
          <!-- FECHA -->
          <td class="px-3 py-2">
            {{ ord.order_Date | date:'dd/MM/yyyy' }}
          </td>

          <!-- HORA -->
          <td class="px-3 py-2">
            {{ ord.start_time | hora }}
          </td>

          <!-- PROYECTO -->
          <td class="p-3 max-w-[160px] sm:max-w-none
                  overflow-x-auto
                  whitespace-nowrap
                  scrollbar-thin">  
            <div class="">
              {{ ord.proj_name.trim() }}
            </div>
          </td>

          <td class="p-3 max-w-[160px] sm:max-w-none
              overflow-x-auto
              whitespace-nowrap
              scrollbar-thin">
            <div class="font-medium">
              {{ ord.prod_code.trim() }}
            </div>
          </td>

          <!-- PRODUCTO -->
          <td class="p-3 max-w-[160px] sm:max-w-none
                  overflow-x-auto
                  whitespace-nowrap
                  scrollbar-thin">
            <div class="">
              {{ ord.prod_descr.trim() }}
            </div>
          </td>

          <!-- M3 -->
          <td class="px-3 py-2 text-center">
            {{ ord.order_qty }}
          </td>

          <!-- CAMIONES -->
          <td class="px-3 py-2 text-center">
            {{ ord.loads }}
          </td>

          <!-- FRECUENCIA -->
          <td class="px-3 py-2 text-center">
            {{ ord.truck_spacing_mins }} min
          </td>

          <!-- DIRECCIÓN -->
          <td class="p-3 max-w-[160px] sm:max-w-none
                  overflow-x-auto
                  whitespace-nowrap
                  scrollbar-thin">
            {{ ord.ship_addr_line?.trim() }}
          </td>

          <!-- COMUNA -->
          <td class="px-3 py-2 sm:max-w-none
              overflow-x-auto
              whitespace-nowrap
              scrollbar-thin">
            {{ ord.comuna?.trim() }}
          </td>

          <!-- ESTADO -->
          <td class="px-3 py-2 text-center">
            <span
              class="px-2 py-1 rounded-full text-[10px]"
              [ngClass]="{
                'bg-green-100 text-green-700': ord.estado === 'Normal',
                'bg-yellow-100 text-yellow-700': ord.estado !== 'Normal'
              }"
            >
              {{ ord.estado }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- SIN PEDIDOS -->
  <div
    *ngIf="!loading && hasSelectedProject && viewMode && filteredOrders.length === 0"
    class="bg-white shadow-lg rounded-2xl mt-10 border border-gray-200
          p-10 text-center text-gray-500 animate__animated animate__fadeIn">

    <div class="flex justify-center mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-14 h-14 text-cyan-600"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="1.5">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 9v3.75m0 3h.008M10.29 3.86l-8.09 14.02A1.5 1.5 0 0 0 3.5 20.25h17a1.5 1.5 0 0 0 1.3-2.37L13.71 3.86a1.5 1.5 0 0 0-2.42 0Z" />
      </svg>
    </div>

    <p class="text-lg font-semibold mb-2">
      No tienes pedidos asignados
    </p>

    <p class="text-sm">
      Cuando existan pedidos, los verás reflejados aquí.
    </p>
  </div>
</div>

<app-seguimiento-overlay
  *ngIf="showSeguimiento"
  [ord]="ordenSeleccionada"
  (close)="showSeguimiento = false">
</app-seguimiento-overlay>