<header class="bg-cyan-700 text-white p-4 rounded-t-lg flex justify-between items-center shadow-sm">
  <h1 class="text-xl font-semibold">Mis Productos</h1>
  <span class="text-sm opacity-90">
    Actualizado al {{ today | date:'dd/MM/yyyy' }}
  </span>
</header>

<div class="p-4 bg-gray-50">

  <div class="bg-white shadow-md rounded-xl p-4 flex flex-col sm:flex-row gap-4 items-center">
    <div class="flex-1">
      <div class="font-semibold">{{ customerName }}</div>
      <div class="text-sm text-gray-500">{{ customerAddress }}</div>
    </div>

    <select
      class="select select-bordered bg-gray-50 w-full sm:w-64"
      [(ngModel)]="selectedProduct"
      (change)="onFilterChange()">
      <option value="">Seleccionar la obra</option>
      <option *ngFor="let p of products" [value]="p.item_code">
        {{ p.item_code }}
      </option>
    </select>

    <button
      class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow-sm
             w-full sm:w-auto mt-2 sm:mt-0"
      (click)="clearFilter()">
      Limpiar
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-8 text-gray-500">
    Cargando productos...
  </div>

  <!-- Tabla -->
  <div *ngIf="!loading && products.length > 0"
       class="overflow-x-auto mt-6 bg-white rounded-lg shadow">

    <table class="min-w-full text-sm">
      <thead class="bg-cyan-700 text-white">
        <tr>
          <th class="p-3 text-left">Producto</th>
          <th class="p-3 text-left">Código</th>
          <th class="p-3 text-left">Orden</th>
          <th class="p-3 text-left">Respaldado</th>
          <th class="p-3 text-left">Utilizado</th>
          <th class="p-3 text-left">Saldo</th>
        </tr>
      </thead>

      <tbody>
          <ng-container *ngFor="let g of groupedProducts">      
            <tr
              class="border-t bg-white hover:bg-cyan-50 cursor-pointer font-semibold"
              (click)="toggleGroup(g.product_code)"
            >
              <td class="p-3">{{ g.product_desc }}</td>
              <td class="p-3">{{ g.product_code }}</td>
              <td class="p-3">—</td>
              <td class="p-3">{{ g.totalQuantity }}</td>
              <td class="p-3">0</td>
              <td class="p-3">{{ g.totalQuantity }}</td>
            </tr>   
               
       <ng-container *ngIf="expandedGroup === g.product_code">
          <tr
            *ngFor="let p of g.items"
            class="bg-gray-100 text-sm"
          >
            <td class="p-3 pl-8">↳ {{ p.product_desc }}</td>
            <td class="p-3">{{ p.product_code }}</td>
            <td class="p-3">{{ p.order_code }}</td>
            <td class="p-3">{{ p.quantity }}</td>
            <td class="p-3">0</td>
            <td class="p-3">{{ p.quantity }}</td>
          </tr>
        </ng-container>        
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
<div
    *ngIf="!loading && totalPages > 1"
    class="flex items-center justify-between mt-6 px-4">
    
    <button
      class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg disabled:opacity-50"
      (click)="prevPage()"
      [disabled]="page === 1">
      ← Anterior
    </button>

    <div class="text-sm text-gray-600">
      Página <strong>{{ page }}</strong> de <strong>{{ totalPages }}</strong>
    </div>
    
    <button
      class="btn bg-cyan-700 text-white hover:bg-cyan-800 px-4 py-2 rounded-lg disabled:opacity-50"
      (click)="nextPage()"
      [disabled]="page === totalPages">
      Siguiente →
    </button>
  </div>

  <footer class="mt-10 text-xs text-gray-400 text-center">
    © {{ currentYear }} TRANSEX CLIENT UI — Todos los derechos reservados.
  </footer>
</div>
