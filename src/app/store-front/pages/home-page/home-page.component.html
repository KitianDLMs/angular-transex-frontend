<header class="bg-cyan-700 text-white p-4 rounded-t-lg flex justify-between items-center shadow-sm">
  <h1 class="text-xl font-semibold">Mis Productos</h1>
  <span class="text-sm opacity-90">
    Actualizado al {{ today | date:'dd/MM/yyyy' }}
  </span>
</header>

<div class="p-4 bg-gray-50">
  <div class="bg-white shadow-md rounded-xl p-4 border border-gray-200 flex flex-col sm:flex-row sm:items-center gap-4">
    <div class="text-gray-600 text-center sm:text-left sm:mr-auto animate__animated animate__fadeIn">
      <div class="font-semibold flex items-center justify-center sm:justify-start gap-2" [ngClass]="{ 'mb-3 mt-3': authService.isAdmin()}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5.121 17.804A9 9 0 1118.879 17.804 A4.5 4.5 0 0012 13.5 a4.5 4.5 0 00-6.879 4.304z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 12a4 4 0 100-8 4 4 0 000 8z"/>
        </svg>
    
        <ng-container *ngIf="userCustCodes.length > 1; else singleCustomer">
          <select [(ngModel)]="selectedCustCode" (change)="onCustomerChange()"
                  class="select select-bordered bg-gray-50">
            <option *ngFor="let code of userCustCodes" [value]="code">
              {{ customersData[code].name || code }}
            </option>
          </select>
        </ng-container>    
        <ng-template #singleCustomer>
          <span>{{ customerName }}</span>
        </ng-template>
      </div>   
    </div>
    <select class="select select-bordered bg-gray-50 w-full sm:w-64"
            (change)="onSelectProject()"
            [(ngModel)]="selectedProject">
      <option value="">Todas las obras</option>
      <option *ngFor="let proj of projectOptions" [value]="proj.proj_code.trim()">
        {{ proj.proj_code.trim() }} - {{ proj.proj_name.trim() }}
      </option>
    </select>
    <button class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow-sm w-full sm:w-auto mt-2 sm:mt-0"
            (click)="clearFilter()">
            <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 20l5-5m0 0l3 3m-3-3l6-6m3-3a2.828 2.828 0 10-4-4l4 4z"
          />
        </svg>
      Limpiar
    </button>
  </div>

  <div *ngIf="loading" class="flex flex-col items-center justify-center p-6 text-gray-500 gap-3 animate__animated animate__fadeIn">
    <img src="assets/images/logoHORMIGONES.png" alt="Cargando" class="h-8 w-8 animate-pulse" />
    <span>Cargando productos...</span>
  </div>

  <div *ngIf="!loading && products.length > 0"
      class="overflow-x-auto mt-6 bg-white rounded-lg shadow animate__animated animate__fadeIn">

    <table class="min-w-full text-sm">
      <thead class="bg-cyan-700 text-white">
        <tr>
          <th class="p-3 text-left">Producto</th>
          <th class="p-3 text-left">Código</th>
          <th class="p-3 text-left">Orden</th>
          <th class="p-3 text-left">Respaldado</th>
          <th class="p-3 text-left">Utilizado</th>
          <th class="p-3 text-left">Saldo</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let p of products">

          <tr class="border-t bg-white hover:bg-cyan-50 cursor-pointer font-semibold"
              (click)="toggleGroup(p.codigo)">
            <td class="p-3 max-w-[160px] sm:max-w-none
                overflow-x-auto
                whitespace-nowrap
                scrollbar-thin">{{ p.producto }}</td>
            <td class="p-3">{{ p.codigo }}</td>
            <td class="p-3">—</td>
            <td class="p-3">{{ p.respaldado }}</td>
            <td class="p-3">{{ p.utilizado }}</td>
            <td class="p-3">{{ p.saldo }}</td>
          </tr>

          <ng-container *ngIf="expandedGroup === p.codigo">
            <tr *ngFor="let o of p.ordenes" class="bg-gray-100 text-sm">
              <td class="p-3 pl-8">↳</td>
              <td class="p-3">{{ p.codigo }}</td>
              <td class="p-3 max-w-[160px] sm:max-w-none
                overflow-x-auto
                whitespace-nowrap
                scrollbar-thin">OC/{{ o.ordencompra }}</td>
              <td class="p-3">{{ o.respaldado }}</td>
              <td class="p-3">{{ o.utilizado }}</td>
              <td class="p-3">{{ o.saldo }}</td>
            </tr>
          </ng-container>

        </ng-container>
      </tbody>
    </table>
  </div>


  <div *ngIf="!loading && products.length === 0"
       class="bg-white shadow-lg rounded-2xl mt-10 border border-gray-200 p-10 text-center text-gray-500 animate__animated animate__fadeIn">
    <div class="flex justify-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3.75m0 3h.008M10.29 3.86l-8.09 14.02A1.5 1.5 0 0 0 3.5 20.25h17a1.5 1.5 0 0 0 1.3-2.37L13.71 3.86a1.5 1.5 0 0 0-2.42 0Z" />
      </svg>
    </div>
    <p class="text-lg font-semibold mb-2">No tienes productos asignados</p>
    <p class="text-sm">Cuando existan productos, los verás reflejados aquí.</p>
  </div>

  <div *ngIf="!loading && products.length > 0" class="flex items-center justify-between mt-6 px-4">
    <button class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg disabled:opacity-50"
            (click)="prevPage()"
            [disabled]="page === 1">
      ← Anterior
    </button>

    <div class="text-sm text-gray-600">
      Página <strong>{{ page }}</strong> de <strong>{{ totalPages }}</strong>
    </div>

    <button class="btn bg-cyan-700 text-white hover:bg-cyan-800 px-4 py-2 rounded-lg disabled:opacity-50"
            (click)="nextPage()"
            [disabled]="page === totalPages">
      Siguiente →
    </button>
  </div>
</div>
